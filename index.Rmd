---
title: "Scripting for Geo-Information Sciences, demonstration of capabilities"
author: "Lo√Øc Dutrieux, Jan Verbesselt"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    theme: united
    toc: true
    toc_depth: 4
    number_sections: true
---

# Today's items

## ToDo in the morning

- Finalise yesterdays [lesson and excercise](https://geoscripting-wur.github.io/Scripting4GeoIntro/#gettingstarted)
- Have a look at the demo's below. Just run and see.

## Objective of today

Demonstration of geo-scripting potential. This will be done by providing geo-spatial showcases (e.g. data manipulation, visualization, Analysis). 
Every showcase will be followed by:

- A reflection of what is the interest of using scripting for that particular problem
- An assessment of the R knowledge required to perform that particular problem

## Learning outcomes of today:

The objective of that lecture is to provide an overview of the capabilities of scripting to solve common problems of the Geo-Information world. The lesson is organized as a set of examples that you can run, visualize the output and understand how the use of scripting was beneficial to tackling the geo-issue. Following each example a reflection is provided on the interest of using scripting for tackling that particular issue as well as associated scripting skills that were required in the example.

So more specifically, at the end of the day you should:

* Have an idea of what can be achieved using scripting
* Identify a situation where the use of scripting is beneficial over click based approach
* Have identified how scripting can benefit your own project e.g. master thesis research questions

# Why scripting?

## Automation

The use of scripting is particularly well suited for automation. 
Automated systems can take different forms; 

- online systems that deliver updated information every day without human intervention needed (e.g. weather prediction). 

- more simple systems that e.g. to extract date from a satellite image file name.

### Example 1: Integrated analysis chain from download to analysis

In the script below we does the following:

- download SRTM data for a country e.g. Belgium
- randomly sample height data
- visualise results in an interactive plot

```{r, eval=FALSE, echo=FALSE}
library(raster)
# getData('ISO3')
```


```{r, eval=TRUE, message=FALSE, fig.align='center', fig.width=6, fig.lp="Randomly sample height in Belgium"}
## libraries needed
library(raster)
library(spatstat)
library(rgeos)
## you can choose your own country here
bel <- getData('alt', country='BEL', mask=TRUE) ## SRTM 90m height data
belshp <- getData('GADM', country='BEL', level=2) ## administrative boundaries
## create random points
dran <- runifpoint(500, win = as.vector(extent(bel)))
## make the random point spatial points
S <- SpatialPoints(data.frame(x = dran$x, y = dran$y), 
            proj4string = CRS(proj4string(belshp)))
## select only the once within belgium
Sint <- gIntersection(S, belshp)
## create a map
plot(bel)
plot(belshp, add=TRUE)
plot(Sint, add = TRUE, col = "red", pch = 19, cex = 0.2)
```

Now we can sample the height data and visualise in the nice interactive scatterplot:

```{r, message=FALSE}
suppressPackageStartupMessages(library(googleVis))
out <- extract(bel, Sint, df = TRUE, sp = TRUE)
df <- data.frame(out@coords, height = out@data, row.names=NULL)
names(df) <- c('x', 'y', 'height')
df$x <- NULL
```

```{r, results='asis', echo=FALSE, fig.align='center'}
sc <- gvisScatterChart(data=df,
                        options=list(width=600, height=500,
                            legend='none',
                            hAxis="{title:'Y (Latitude)'}",
                            vAxis="{title:'Height'}"))
print('<center>')
print(sc)
print('</center>')
```

This example can easily be ran for every country of the world with minimal human intervention, and therefore also constitute an other case of automation.

**Try it yourself**: You can use the script below to analyse height (or climate data) for your own country by modifying the script above!

### Example 2: Visualising mean world precipitation dynamics

Visualising mean world precipitation automatically downloaded from http://www.worldclim.org/methods

```{r, fig.width=10, fig.height=5, fig.show='animate', message=FALSE}
library(raster)
library(rasterVis)
library(colorspace)
prec <- getData('worldclim', var='prec', res=10)
names(prec) <- month.abb
cols <- heat_hcl(12, h = c(0, -100), l = c(75, 40), c = c(40, 80), power = 1)
cols <- rev(sequential_hcl(12))
for (i in 1:12) {
    plot(prec, i, zlim=c(0,500), col=cols)
}
```

### The contribution of scripting

- ability to automatically download data from any place in the world
- quick and efficient analysis by sampling data randomly
- can easiliy be repeated for other countries, other datasets (reproducible)
- Fully integrated analysis chain, from data download to output

### Basic scriping skills required

- String handling (generate automatic file names, recognize patterns, etc ...)
- Query lists and data.frames
- Error handling
- handle raster and vector data
- Understand and use basic spatial analysis functions

## Flexibility

With GIS software you are often limited to set of feature the software provides and anything beyond is either very hard to implement or even impossible. Scripting offers a much greater flexibility, to:

* Explore your data in all its dimensions
* Implement complex and custom made algorithms and functions.

### The example 1 - *Visualize the temporal profile of a pixel*

The example bellow illustrates how a small function allows to quickly visualize temporal profile of a raster time-series.

```{r, eval=FALSE}
# Download a spatio-temporal dataset
download.file(url = 'https://github.com/dutri001/bfastSpatial/raw/master/data/tura.rda', destfile = 'tura.rda', method = 'auto')
load('tura.rda')
```

There is now a variable named `tura` in your environment, it is a time-series of NDVI over an area of Ethiopia.

```{r, eval=FALSE}
library(zoo)
# Define the function to extract and plot the time series
click2ts <- function(x) {
    val <- click(x, n = 1)
    z <- getZ(x)
    plot(zoo(t(t), z), type = 'p', pch = 20, xlab = 'Time', ylab = 'NDVI (-)')
}
```

Then run the code block below. R will be waiting for you to click on the map, and quickly after the time-series will appear.


```{r, eval=FALSE}
plot(tura, 1)
click2ts(tura)
```

### The contribution of scripting

Exploring the temporal dimension of a dataset is often not possible in classical GIS environments. The flexibility of scripting allows to do that with minimal efforts.

### Basic scripting skills required

* Understand the structure of spatial objects
* Write functions

### The example 2 - *Implement a custom made function to a raster time-series*

The example below uses a time-series of MODIS VCF data, which correspond to percentage tree cover, to investigate temporal trends of tree cover over the Netherlands.

```{r, eval=FALSE}
## Trend calculator
library(zoo)
library(lubridate)
library(raster)

# Download data (if it doesn't work, try with method='wget')
download.file(url = 'https://github.com/GeoScripting-WUR/Scripting4Geo/raw/gh-pages/data/MODIS_VCF_2000-2010_NL.rds', destfile = 'tura.rda', method = 'auto')
# Read the data
modis <- readRDS('MODIS_VCF_2000-2010_NL.rds')
# Clean data (values > 100 correspond to water)
modis[modis > 100] <- NA
# Visualize
plot(modis, 1)
```

```{r, echo=FALSE, fig.align='center'}
# For compiling tutorial
modis <- readRDS('data/MODIS_VCF_2000-2010_NL.rds')
modis[modis > 100] <- NA
# Visualize
plot(modis, 1)
```

```{r, eval=FALSE}
# For the example we will reduce the extent so that processing does not take too long
e <- extent(340101, 370323, 5756221, 5787772)
plot(e, add=TRUE)
modis_sub <- crop(modis, e)
plot(modis_sub, 1)

# Define function to calculate temporal trends
fun <- function(x) {
    ts <- zoo(x, time)
    df <- data.frame(t = decimal_date(index(ts)), vcf = c(ts))
    lm(vcf ~ t, data = df)$coefficients[2]
}

# Run the function spatially (this may take a few minutes, time for a break?)
time <- getZ(modis)
out <- calc(x = modis_sub, fun = fun)

# Visualize output
plot(out)
```

You should see a map displaying the tree cover percentage temporal trends for the 2000-2010 period.

### Contribution of scripting

Scripting thanks to its flexibility offers the possibility to implement any custom made function to any dataset.

### Basic scripting skills required

* Write functions
* Manipulate spatial objects
* Know well the details of the functions/algorithms to be implemented spatially

## Visualization

We saw earlier that simple maps can be produced with R for display in reports or static supports. R also offers more advanced visualisation capabilities, particularly suited for web content.

### The example - *Interactive maps*

The map below (created using the googleVis package) displays statistics about the national parks of Europe. The data is automatically read from [the wikipedia page](http://en.wikipedia.org/wiki/List_of_national_parks#Europe), cleaned and formatted in a data frame, and a webmap is created using the `gvisGeoChart()` function. If you hover over the dots, the value of the mapped variables is displayed. The googleVis package provides wrappers to easily produce such kind of maps using the [google visualization API](https://google-developers.appspot.com/chart/interactive/docs/gallery/geochart).

```{r, echo=FALSE, results='asis'}
library(googleVis)
library(XML)

# Read table from html
url <- "http://en.wikipedia.org/wiki/List_of_national_parks"
x <- readHTMLTable(readLines(url), which=3, stringsAsFactors = FALSE)

# Clean up df 
colnames (x) <- c('country', 'oldest', 'number', 'area_tot', 'country_percentage')
x$oldest <- as.numeric(x$oldest)
x$number <- as.numeric(gsub("\\*", "", x$number))
x$area_tot <- as.numeric(gsub("(,)|(\\[.*\\])", "", x$area_tot))
x$country_percentage <- as.numeric(gsub("(%)|(\\[.*\\])", "", x$country_percentage))

nationalParks <- x

g <- gvisGeoChart(nationalParks, locationvar="country", colorvar = "oldest", sizevar = "number",
                  options=list(region="150", displayMode="markers", colorAxis="{colors: ['green', 'blue']}"))
print('<center>')
print(g)
print('</center>')
```

### Interactive maps - 2

The above map is nice, but still pretty static; it only display two variables, which we did not choose. The year the first park was created for the dot color, and the total number of parks in the country for the dot size. To make that map a bit more interactive we can embed it in a shiny App. Shiny is among the lattest developments of the R world, supported by RStudio; it provides the possibility to create interactive plots. These app can either be ran in an RStudio session or online.
The app below allows you to select the variables you want to map relating to national park of europe.

<center>
<iframe src="http://loicd.shinyapps.io/shinyGoogleVis" width="600" height="750" frameborder="0">Loading</iframe>
</center>

Much more advanced examples are possible, as shown below, with an integration of shiny and [leaflet](http://leafletjs.com/). (Example provided by [RStudio](http://shiny.rstudio.com/gallery/))


<center>
<iframe src="http://gallery.shinyapps.io/063-superzip-example" width="1100" height="800" frameborder="0">
</iframe>
</center>

### Contribution of scripting

* "User friendly" interface to javascript libraries

### Basic scipting skills required

* dataframe manipulation
* String manipulation (subsetting, pattern matching)
* Function writting

## Reproducibility

All examples shown in this demo have at least one characteristic in common; they are all **reproducible**. While you may not always remember the parameters you have selected when analyzing or creating map in a GIS environment, scripting leaves a fully reproducible mark of what you have done.

# Today's summary

To summarize, we saw today that scripting can be used for many purposes:

* Automate steps and deal with large amounts of data
* Solve complex problems (run custom made functions, while traditional GIS environments are limited to the features they provide)
* Make work reproducible (also beneficial for collaboration)
* Visualize data and build interactive geo data visualization tools


# Assignment

Submit a (maximum) 1 page document where you identify:

- the potential contribution of Geo-scripting for yourself, 
- as well as the specific R or python knowledge you would need to learn about. 

Keep it short, to the point and structured.


# Inspiration and more info

- http://www.magesblog.com/2012/05/interactive-reports-in-r-with-knitr-and.html
- https://gis.stackexchange.com/questions/93096/how-to-perform-a-true-gis-clip-of-polygons-layer-using-a-polygon-layer-in-r

Yet another tutorial:

- https://pakillo.github.io/R-GIS-tutorial/
- http://github.com/mages/googleVis

About projections and code: https://www.nceas.ucsb.edu/scicomp/recipes/projections


<!--Demonstrate potential
Trigger interest
Help students mapping (in their mind) the concepts and knowledge they will learn and require later in the course
This will be done by providing showcases of about everything (data manipulation, visualization, Analysis). Every showcase fill be followed by:
A reflection on what is the interest of using scripting for that particular problem
An assessment of the R knowledge required to perform that particular problem
This lesson should be structured analogically to the course overall.

Example showcases:
An automated raster processing chain (from raw input (or download) to end product)
Make a reproducible map
Extract features immediately followed by statistical analysis
Communicate result with a beautiful interactive (shiny) map
Bonus: If every showcase is embedded into a real world story, that is definitely a bonus
-->


